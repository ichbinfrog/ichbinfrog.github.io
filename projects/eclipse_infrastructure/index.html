<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="">
<meta name="description" content="It is important to note here that choices regarding the infrastructure cascade from decisions made in the implementation of the core components and the monitoring stack and not vice versa.
Kubernetes cluster creation Creating the underlying computing and networking resources for a functional k8s cluster can be done in two distinct ways:
 Manual:  Create the node pool on which Kubernetes will run Create networking resources to connect the different nodes in the same subnet Setup the k8s prerequisites (disable swap on all machines, install docker) via Ansible then the k8s architecture via Ansible while keeping in mind the differences between the master and worker nodes or with the kubespray tool." />
<meta name="keywords" content=", terraform, kubernetes, packer, GCP" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://ichbinfrog.github.io/projects/eclipse_infrastructure/" />
<script type="text/javascript" async
src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            displayMath: [['$$', '$$']],
            processEscapes: true,
            processEnvironments: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
            TeX: {
                equationNumbers: { autoNumber: "AMS" },
                extensions: ["AMSmath.js", "AMSsymbols.js"]
            }
        }
    });
    MathJax.Hub.Queue(function () {
        
        
        
        var all = MathJax.Hub.getAllJax(), i;
        for (i = 0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });

    MathJax.Hub.Config({
        
        TeX: { equationNumbers: { autoNumber: "AMS" } }
    });
</script>


    <title>
        
            Eclipse/steady — Infrastructure provisioning :: Hoang Quoc Trung 
        
    </title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="/main.min.cbd9ce6c3a26d6c4a5eb4b8834c18d83518654bd8bac1fc8160486f336181c9a.css">


    
        <link rel="stylesheet" type="text/css" href="/css/post.css">
    





<meta itemprop="name" content="Eclipse/steady — Infrastructure provisioning">
<meta itemprop="description" content="It is important to note here that choices regarding the infrastructure cascade from decisions made in the implementation of the core components and the monitoring stack and not vice versa.
Kubernetes cluster creation Creating the underlying computing and networking resources for a functional k8s cluster can be done in two distinct ways:
 Manual:  Create the node pool on which Kubernetes will run Create networking resources to connect the different nodes in the same subnet Setup the k8s prerequisites (disable swap on all machines, install docker) via Ansible then the k8s architecture via Ansible while keeping in mind the differences between the master and worker nodes or with the kubespray tool.">
<meta itemprop="datePublished" content="2019-10-30T11:25:00&#43;00:00" />
<meta itemprop="dateModified" content="2019-10-30T11:25:00&#43;00:00" />
<meta itemprop="wordCount" content="740">
<meta itemprop="image" content="https://ichbinfrog.github.io/"/>



<meta itemprop="keywords" content="terraform,kubernetes,packer,GCP," />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://ichbinfrog.github.io/"/>

<meta name="twitter:title" content="Eclipse/steady — Infrastructure provisioning"/>
<meta name="twitter:description" content="It is important to note here that choices regarding the infrastructure cascade from decisions made in the implementation of the core components and the monitoring stack and not vice versa.
Kubernetes cluster creation Creating the underlying computing and networking resources for a functional k8s cluster can be done in two distinct ways:
 Manual:  Create the node pool on which Kubernetes will run Create networking resources to connect the different nodes in the same subnet Setup the k8s prerequisites (disable swap on all machines, install docker) via Ansible then the k8s architecture via Ansible while keeping in mind the differences between the master and worker nodes or with the kubespray tool."/>



    <meta property="og:title" content="Eclipse/steady — Infrastructure provisioning" />
<meta property="og:description" content="It is important to note here that choices regarding the infrastructure cascade from decisions made in the implementation of the core components and the monitoring stack and not vice versa.
Kubernetes cluster creation Creating the underlying computing and networking resources for a functional k8s cluster can be done in two distinct ways:
 Manual:  Create the node pool on which Kubernetes will run Create networking resources to connect the different nodes in the same subnet Setup the k8s prerequisites (disable swap on all machines, install docker) via Ansible then the k8s architecture via Ansible while keeping in mind the differences between the master and worker nodes or with the kubespray tool." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ichbinfrog.github.io/projects/eclipse_infrastructure/" />
<meta property="og:image" content="https://ichbinfrog.github.io/"/>
<meta property="article:published_time" content="2019-10-30T11:25:00+00:00" />
<meta property="article:modified_time" content="2019-10-30T11:25:00+00:00" /><meta property="og:site_name" content="Hoang Quoc Trung" />






    <meta property="article:published_time" content="2019-10-30 11:25:00 &#43;0000 UTC" />








    </head>

    <body class="">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">ichbinfrog</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="https://ichbinfrog.github.io/about">About</a></li><li><a href="https://ichbinfrog.github.io/projects">Projects</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            
            <span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            
            </p>
        </div>

        <article>
            <h2 class="post-title" id="top"><a href="https://ichbinfrog.github.io/projects/eclipse_infrastructure/">Eclipse/steady — Infrastructure provisioning</a></h2>
            <aside id="toc"><style>
.toc {
    position: fixed;
    top: 50%;
    left: 2%;
    width: 20%;
    transform: translateY(-50%);
    border-radius: 5px;
    padding-bottom: 1rem;
}

.toc a {
    text-decoration: none;
    color: gray;
}

.toc a:hover {
    opacity: 0.5;
}

.toc ul {
    list-style: ">  ";
}

.toc-title {
    text-decoration: underline;
}
</style>

<div class="toc">
    <div class="toc-title">Table of Contents</div>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#kubernetes-cluster-creation">Kubernetes cluster creation</a></li>
    <li><a href="#terraforming-the-cluster">Terraforming the cluster</a></li>
    <li><a href="#customizing-the-base-image-with-packer">Customizing the base image with Packer</a></li>
  </ul>
</nav>
    <ul>
    <li><a href="#top">Top</a></li>
    <li><a href="#end">End</a></li>
    </ul>
</div></aside>

            

            <div class="post-content">
                <p>It is important to note here that choices regarding the infrastructure cascade from decisions made in the implementation of the core components and the monitoring stack and not vice versa.</p>
<h2 id="kubernetes-cluster-creation">Kubernetes cluster creation</h2>
<p>Creating the underlying computing and networking resources for a functional k8s cluster can be done in two distinct ways:</p>
<ul>
<li><strong>Manual</strong>:
<ul>
<li>Create the node pool on which Kubernetes will run</li>
<li>Create networking resources to connect the different nodes in the same subnet</li>
<li>Setup the k8s prerequisites (disable swap on all machines, install docker) via Ansible then the k8s architecture via Ansible while keeping in mind the differences between the master and worker nodes or with the <strong>kubespray</strong> tool.</li>
</ul>
</li>
<li><strong>Hosted control plane</strong>: rent the control plane (etcd, metrics server) and define the node pool resources to be automatically provisioned.</li>
</ul>
<p>The first option allows for a better control of the environment in which the cluster runs at the expense of higher overhead cost (more scripts to manage). The difficulty of creating and maintaining up-to-date and reproducible infrastructure code (even with Ansible) directly violates the lower overhead and reproductibility objectives defined above. The usage of tools such as Ansible also increases the time to spin up an instance drastically, thus, violating the goal to reduce spin up time.</p>
<p>Whereas, the hosted option exchanges that control for a auto-managed cluster with extra services (automated backup of the etcd server, metrics, monitoring and logging stack often external to the cluster itself). As it does not entail drawbacks that go against the objectives defined, this cluster creation method is chosen hereinafter.</p>
<hr>
<h2 id="terraforming-the-cluster">Terraforming the cluster</h2>
<p>Terraform is the tool chosen that allows use Infrastructure as Code to provision and manage any cloud, infrastructure, or service. As such, environments created with the aforementioned tool are reproducible and changes can be easily mapped out, planned and applied deterministically.</p>
<p>In practice, terraform &ldquo;code&rdquo; is a declarative JSON variant with which <strong>resources</strong> (describing a one or a group of infrastructure objects, such as virtual networks, compute instances, or higher-level components such as DNS records), <strong>providers</strong> (describing a set of resources types defined for a specific API, cloud provider, etc&hellip;) as well as <strong>variables</strong> which can reference each other. The snippet below gives an overview of a typical declaration:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#66d9ef">provider</span> <span style="color:#e6db74">&#34;google&#34;</span> {
  project <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;acme-app&#34;</span>
  region  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;us-central1&#34;</span>
}

<span style="color:#66d9ef">variable</span> <span style="color:#e6db74">&#34;machine_type_1&#34;</span> {
  type    <span style="color:#f92672">=</span> <span style="color:#66d9ef">string</span>
  default <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;f1-micro&#34;</span>
}

<span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;google_compute_instance&#34; &#34;default&#34;</span> {
  name         <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;vm_1&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e">  # reference to the variable machine_type_1
</span><span style="color:#75715e"></span>  machine_type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${var.machine_type_1}&#34;</span>
  zone         <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;us-west1-a&#34;</span>
}
</code></pre></div><p>As different cloud providers offer distinct APIs for their object creation, the Figure below illustrates the global steps in the creation of the cluster.</p>

<img src="/img/terraform_gcp.png"  class="center"  />


<p>Since the order of execution of resource creation is computed by terraform, the following steps are performed. First a subnetwork is created within a given network and allocated a range of private IPs (this step, although unnecessary is preferred over using the default subnet for better isolation). Then the cluster object (control plane) is created and &ldquo;nested&rdquo; in the referred subnet. Finally, terraform creates the node pool without any nodes and declares it as a slave of the cluster object then spins up the amount of nodes and the appropriate resources that will be incorporated in the node pool.</p>
<hr>
<h2 id="customizing-the-base-image-with-packer">Customizing the base image with Packer</h2>
<p>On the other hand, one can create a base image with all the requirements and export it into a reusable base image. Enter <strong>Packer</strong>, an open source tool developed by Hashicorp which is uses that concept for creating identical machine images for multiple platforms from a single source configuration. Declarations consist of a set of <strong>Builders</strong> (responsible for creating machines and generating images from them for various platforms), <strong>Provisioners</strong> (to install and configure the machine image after booting) and <strong>Post-Processors</strong> (to upload, re-package artifacts).</p>
<p>In our use case, the base image is the <strong>Ubuntu Disco Dingo</strong> (19.04) server install image. By leveraging Packer&rsquo;s boot command functionality, specific OS configurations are injected using <strong>preseeding</strong> (for instance apt setup, pre-partitioning, etc&hellip;). Then with the Ansible or Shell provisioner, the post-boot system requirements are installed. The image is then exported to the appropriate platforms defined if the build process succeeds.</p>
<p>Developping &ldquo;PackerFiles&rdquo; is a grueiling process due to the fact the VM build stage is not layered, any error would require an excruciatingly long complete rebuild. Therefore, using prebuilt templates such as Chef Bento (open source packer templates for building minimal Vagrant baseboxes for multiple platforms) is mandatory in order to maintain a decently fast workflow.</p>

            </div>
        </article>
        <h2 id="end"></h2>
        <hr />

        <div class="post-info">
  				<p>
  					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://ichbinfrog.github.io/tags/terraform">terraform</a></span><span class="tag"><a href="https://ichbinfrog.github.io/tags/kubernetes">kubernetes</a></span><span class="tag"><a href="https://ichbinfrog.github.io/tags/packer">packer</a></span><span class="tag"><a href="https://ichbinfrog.github.io/tags/gcp">GCP</a></span>
  				</p>
  		</div>
    </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2020</span>
            
            <span><a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></span>
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            <span><a href="https://themes.gohugo.io/hugo-theme-hello-friend-ng/">hello-friend-ng</a> Theme for <a href="http://gohugo.io">Hugo</a> by <a href="https://github.com/rhazdon">Djordje Atlialp</a></span>
        </div>
    </div>
</footer>

            
        </div>

        




<script type="text/javascript" src="/bundle.min.dc716e9092c9820b77f96da294d0120aeeb189b5bcea9752309ebea27fd53bbe6b13cffb2aca8ecf32525647ceb7001f76091de4199ac5a3caa432c070247f5b.js" integrity="sha512-3HFukJLJggt3&#43;W2ilNASCu6xibW86pdSMJ6&#43;on/VO75rE8/7KsqOzzJSVkfOtwAfdgkd5BmaxaPKpDLAcCR/Ww=="></script>



    </body>
</html>
